<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影视站流量统计</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: url('https://imgapi.xl0408.top/index.php') no-repeat center center fixed;
            background-size: cover;
            overflow: hidden;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            /* 调整透明度 */
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            /* 添加模糊效果 */
            animation: fadeIn 1.5s ease-in-out;
            /* 添加淡入动画，持续时间调整为1.5秒 */
        }

        h1 {
            text-align: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            opacity: 0;
            /* 初始设置表格透明度为0 */
            transition: opacity 1s ease-in-out;
            /* 添加渐变效果 */
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .data-table th {
            background-color: #f2f2f2;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .loader {
            border: 6px solid #f3f3f3;
            border-radius: 50%;
            border-top: 6px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
            /* 初始隐藏加载动画 */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="loader"></div> <!-- 加载动画 -->
    <div class="container">
        <h1>影视站流量统计</h1>
        <table class="data-table">
            <thead>
                <tr>
                    <th>标题</th>
                    <th>IP数</th>
                    <th>浏览量</th>
                    <th>访客数</th>
                    <th>会话数</th>
                    <th>跳出率</th>
                    <th>平均访问时长</th>
                </tr>
            </thead>
            <tbody id="data-body">
                <!-- 数据将被插入到这里 -->
            </tbody>
        </table>
    </div>


<script>
const loader = document.querySelector('.loader');
const dataTable = document.querySelector('.data-table');

// 获取或输入密钥
function getStoredKey() {
    let key = localStorage.getItem('secret_key');
    if (!key) {
        key = prompt("请输入访问密钥：");
        if (!key) {
            alert("必须输入密钥才能访问！");
            throw new Error("未输入密钥");
        }
        localStorage.setItem('secret_key', key);
    }
    return key;
}

// 获取 token，如果过期则重新请求
async function getToken() {
    let token = localStorage.getItem('token');
    let tokenTime = localStorage.getItem('token_time');

    if (!token || !tokenTime || (Date.now() - tokenTime > 24*60*60*1000)) {
        const key = getStoredKey();
        try {
            const resp = await fetch(`http://你的服务器IP:5431/get_token?key=${encodeURIComponent(key)}`);
            const data = await resp.json();
            if (resp.status === 200 && data.token) {
                token = data.token;
                localStorage.setItem('token', token);
                localStorage.setItem('token_time', Date.now());
            } else {
                alert(data.error || "获取 token 失败");
                throw new Error(data.error || "获取 token 失败");
            }
        } catch (err) {
            console.error("获取 token 出错:", err);
            throw err;
        }
    }
    return token;
}

// 请求数据并更新表格
async function fetchDataAndUpdateTable() {
    loader.style.display = 'block';
    try {
        const token = await getToken();
        const url = 'https://www.tongjiniao.com/api/situation/flow?domain_id=609822806072078336';
        const resp = await fetch(url, {
            headers: {
                'Authorization': token,
                'User-Agent': 'Mozilla/5.0'
            }
        });
        const data = await resp.json();

        const dataList = data.data.list;
        const dataBody = document.getElementById('data-body');
        dataBody.innerHTML = '';

        dataList.forEach((item, index) => {
            const row = document.createElement('tr');
            const yesterdayData = dataList[index+1] || dataList.find(d=>d.title==='昨日') || {};
            row.innerHTML = `
                <td>${item.title}</td>
                <td>${item.ip} ${getArrow(item.ip, yesterdayData.ip)}</td>
                <td>${item.pv} ${getArrow(item.pv, yesterdayData.pv)}</td>
                <td>${item.uv} ${getArrow(item.uv, yesterdayData.uv)}</td>
                <td>${item.vv} ${getArrow(item.vv, yesterdayData.vv)}</td>
                <td>${item.br}% ${getArrow(item.br, yesterdayData.br)}</td>
                <td>${item.du} ${getArrow(item.du, yesterdayData.du)}</td>`;
            dataBody.appendChild(row);
        });

        function getArrow(today, yesterday) {
            if(today > yesterday) return '<span style="color:red;">↑</span>';
            if(today < yesterday) return '<span style="color:green;">↓</span>';
            return '';
        }

        loader.style.display = 'none';
        dataTable.style.opacity = '1';
    } catch (err) {
        loader.style.display = 'none';
        console.error(err);
    }
}

// 页面加载立即获取数据
fetchDataAndUpdateTable();
// 定时刷新
setInterval(fetchDataAndUpdateTable, 15000);
</script>

    

</body>

</html>

